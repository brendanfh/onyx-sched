//+optional-semicolons

#load "./module.onyx"

use sched {*}
use core {
    stdio
    aprintf
    alloc
    io
    conv
    time
}

main :: () {
    s := Scheduler.make()

    cancel_this := s->schedule_in(5 * 1000, say_hi, "test")
    s->schedule_in(20 * 1000, say_hi, "test 2")

    s->start()

    stdin := io.reader_make(&stdio.stream)
    while true {
        line := io.read_line(&stdin)
        num  := conv.parse(u32, line) ?? 0
        if num > 0 {
            s->schedule_in(~~num, say_hi, .{
                message = aprintf("SLEPT FOR {}ms", num)
                queued_at = time.now()
            })
        }

        if num == 69 {
            s->cancel(cancel_this)
        }
    }
}

say_hi :: data => {
    logf(.Info, "{}", *data)
}
